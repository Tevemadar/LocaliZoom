<!DOCTYPE html>
<html>
    <head>
        <title>LocaliZoom</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
            body{margin: 0;padding: 0;}
            canvas{display: block;cursor: crosshair;outline: none;}
            canvas#scroller{cursor: pointer;}
            div{display: inline-block;}
            #traf{width: 130px;}
            #status{padding: 5px;background: #F0F0F0;width: 900px;/*height: 20px;*/}
            #coords{float: right;padding-right: 5px;}
            #outline{float:right;height: 18px;}
            #outlinedesc{float:right;padding-right: 5px;}
            #alpha{float:right;height: 15px;width: 100px;}
            #alphadesc{float:right;padding-right: 5px;}
/*            #bright{float:right;height: 15px;width: 100px;}
            #brightdesc{float:right;padding-right: 5px;}*/
            #tools{background: #F0F0F0;height: 20px;padding: 5px;position: absolute;left:0;}
            /*#toolsinner{display: none;}*/
            #toggleAN,#toggleNL,
            #antools,
            #nltools{display: none;}
            #helpbutton{float: right;padding: 5px;}
            #help{display: none;width: 500px;background: #F0F0F0;position: absolute;padding: 10px;}
            #metadata{display: block;position: absolute;text-align: center;}
        </style>
        <script src="cache.js"></script>
        <script src="inflater.js"></script>
        <script src="derle.js"></script>
        <script src="slicer.js"></script>
        <script src="filmstrip.js"></script>
        <script src="zoomer.js"></script>
        <script src="math.js"></script>
        <script>
            var args={atlas:"WHS_SD_Rat_v2_39um"};
            var pairs=window.location.search.substring(1).split("&");
            pairs.forEach(function(pair){
               pair=pair.split("=");
               args[pair[0]]=pair[1] || true;
            });

            // invocation:
            //     filmstripzoom.html?atlas=<atlas_id>&series=<series_id>
            //     [filmstripzoom.html?atlas=<atlas_id>&preview=<atlas_preview_id>&series=<series_id>]
            //
            // example:
            //     filmstripzoom.html?atlas=WHS_Rat_v2.xml&series=R602-33611.xml
            //     [filmstripzoom.html?atlas=WHS_Rat_v2.xml&preview=WHS_Rat_v2.xml.png&series=R602-33611.xml]
            //
            // configuration of URL-s appear in the seven locator functions:
            // 
            // 3 of them are new compared to LocaliZoom
            // 
            //     locators.SeriesLocator:function(series_id)
            //         receives series identifier
            //         returns HTTP GET-able URL for downloading series metadata (N3-compatible xml)
            //         
            //     locators.ThumbLocator:function(section_id)
            //         receives section identifier
            //         returns URI to be used as src attribute of an image object
            //         
            //     locators.AtlasPreviewLocator:function(atlas_id)
            //         receives atlas identifier
            //         returns URI to be used as src attribute of an image object
            // 
            // 4 of them are identical to LocaliZoom
            // 
            //     locators.AtlasLocator(atlas_id)
            //         receives atlas identifier
            //         returns HTTP GET-able URL for downloading the AligNII/ViiNII-compatible atlas-descriptor (xml)
            //
            //     locators.RLELocator(nifti_id,ox,oy,oz,ux,uy,uz,vx,vy,vz)
            //         receives nifti identifier (from atlas-descriptor) and anchor parameters
            //         returns HTTP GET-able URL for downloading RLE-compressed atlas slice
            //
            //     locators.DZILocator(section_id)
            //         receives section identifier
            //         returns HTTP GET-able URL for downloading DZI descriptor (xml)
            //
            //     locators.TileLocator(section_id,level,x,y,format)
            //         receives section identifier, level-x-y pyramidal selectors and tile format (from DZI descriptor)
            //         returns URI to be used as src attribute of an image object
            
            // locators for Navigator. Presumably correct in Navigator3 context
//            var locators={
//                SeriesLocator:function(series_id){return "/navigator/feeder/metadata/?blockId="+series_id;},
//                ThumbLocator:function(section_id){return "/navigator/feeder/thumbnail/?id="+section_id;},
//                AtlasPreviewLocator:function(atlas_id){return "/navigator/filmstripzoom/"+atlas_id;},
//
//                AtlasLocator:function(atlas_id){return "/navigator/feeder/original/?id="+atlas_id;},
//                RLELocator:function(nifti_id,ox,oy,oz,ux,uy,uz,vx,vy,vz){
//                    return "/navigator/feeder/rleslice/?id="+nifti_id
//                            +"&ox="+ox+"&oy="+oy+"&oz="+oz
//                            +"&ux="+ux+"&uy="+uy+"&uz="+uz
//                            +"&vx="+vx+"&vy="+vy+"&vz="+vz;
//                },
//                DZILocator:function(section_id){return "/navigator/feeder/openzoom/?id="+section_id;},
//                TileLocator:function(section_id,level,x,y,format){
//                    return "/navigator/feeder/openzoom/tile/?id="+section_id+"&level="+level+"&column="+x+"&row="+y+"&format="+format;
//                }
//            };

//            var locators={
//                SeriesLocator:function(series_id){return series_id;},
//                ThumbLocator:function(section_id){return "GetThumb.php?id="+section_id;},
//                AtlasPreviewLocator:function(atlas_id){return atlas_id+".png";},
//
//                AtlasLocator:function(atlas_id){return atlas_id+".xml";},
//                RLELocator:function(nifti_id,ox,oy,oz,ux,uy,uz,vx,vy,vz){
//                    return "GetRLE.php?nifti="+nifti_id
//                            +"&ox="+ox+"&oy="+oy+"&oz="+oz
//                            +"&ux="+ux+"&uy="+uy+"&uz="+uz
//                            +"&vx="+vx+"&vy="+vy+"&vz="+vz;
//                },
//                DZILocator:function(section_id){return "GetXML.php?id="+section_id;},
//                TileLocator:function(section_id,level,x,y,format){
//                    return "GetPNG.php?id="+section_id+"&level="+level+"&x="+x+"&y="+y+"&format="+format;
//                }
//            };

//            // Proxy
//            var locators={
//                SeriesLocator:function(series_id){return "fprox.php?feeder=metadata&blockId="+series_id;},
//                ThumbLocator:function(section_id){return "fprox.php?feeder=thumbnail&id="+section_id;},
//                
//                AtlasLocator:function(atlas_id){return atlas_id+".json";},
//                AtlasVolumeLocator:function(atlas_id){return atlas_id+".pack";},
//                
//                DZILocator:function(section_id){return "fprox.php?feeder=openzoom&id="+section_id;},
//                TileLocator:function(section_id,level,x,y,format){
//                    return "fprox.php?feeder=openzoom/tile&id="+section_id+"&level="+level+"&column="+x+"&row="+y+"&format="+format;
//                }
//            };

            // CSCS
            var locators={
                SeriesLocator:function(series_id){return series_id;},
//                ThumbLocator:function(section_id){
//                    return "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/"+
//                            args.pyramids+"/"+
//                            section_id+".png";
//                },
                
                AtlasLocator:function(atlas_id){return atlas_id+".json";},
                AtlasVolumeLocator:function(atlas_id){return atlas_id+".pack";},
                
//                DZILocator:function(section_id){
//                    return "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/"+
//                            args.pyramids+"/"+
//                            section_id+"/"+
//                            section_id.substring(0,section_id.lastIndexOf("."))+".dzi";//(location.search.includes("&xml")?".xml":".dzi");
//                },
//                TileLocator:function(section_id,level,x,y,format){
//                    return "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/"+
//                            args.pyramids+"/"+
//                            section_id+"/"+
//                            section_id.substring(0,section_id.lastIndexOf("."))+"_files/"+
//                            level+"/"+x+"_"+y+".png";
//                }
                DZILocator:args.pyramids.startsWith("buckets/")?
                    function(section_id){
                        return "https://data-proxy.ebrains.eu/api/v1/public/"+
                                args.pyramids+"/"+
                                section_id+"/"+
                                section_id.substring(0,section_id.lastIndexOf("."))+".dzi";//(location.search.includes("&xml")?".xml":".dzi");
                    }:
                    function(section_id){
                        return "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/"+
                                args.pyramids+"/"+
                                section_id+"/"+
                                section_id.substring(0,section_id.lastIndexOf("."))+".dzi";//(location.search.includes("&xml")?".xml":".dzi");
                    },
                TileLocator:args.pyramids.startsWith("buckets/")?
                    function(section_id,level,x,y,format){
                        return "https://data-proxy.ebrains.eu/api/v1/public/"+
                                args.pyramids+"/"+
                                section_id+"/"+
                                section_id.substring(0,section_id.lastIndexOf("."))+"_files/"+
                                level+"/"+x+"_"+y+".png";
                    }:
                    function(section_id,level,x,y,format){
                        return "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/"+
                                args.pyramids+"/"+
                                section_id+"/"+
                                section_id.substring(0,section_id.lastIndexOf("."))+"_files/"+
                                level+"/"+x+"_"+y+".png";
                    }
            };

            function fullscreen(){
                var zc=document.getElementById("zoomcanvas");
                var sc=document.getElementById("scroller");
                sc.addEventListener("wheel",filmstrip.mwheel,true);
                
                var help=document.getElementById("help");
                document.getElementById("metadata").style.top=help.style.top=zc.offsetTop+"px";
                help.style.left=window.innerWidth-520+"px";
                
                filmstrip.setwidth(zc.width=sc.width=canvaswidth=window.innerWidth);
                filmstrip.setheight(sc.height=128+20);
                zc.height=canvasheight=window.innerHeight-zc.offsetTop-128-20;
                if(zoomer)zoomer.fullcanvas();
            }
            
//            var args={atlas:"WHS_SD_Rat_v2_39um"};
            function startup(){
                window.addEventListener("resize",fullscreen);
                fullscreen();
                
//                var pairs=window.location.search.substring(1).split("&");
//                pairs.forEach(function(pair){
//                   pair=pair.split("=");
//                   args[pair[0]]=pair[1] || true;
//                });
                if(args.view){
                    filmstrip.setalpha(0);
                }
                args.view=!args.tools;
                args.prev=true;
                if(args.view){
                    document.getElementById("tools").style.display="none";
                }else{
                    document.getElementById("tools").style.top=document.getElementById("status").offsetHeight+"px";
                    if(args.nl){
                        document.getElementById("toggleNL").style.display="inline";
                    }else{
                        document.getElementById("toggleAN").style.display="inline";
                    }
                }
                if(args.opacity){
                    document.getElementById("alpha").value=args.opacity;
                    //document.getElementById("outline").value="#FFFFFF";
                }
        
                var xhr=new XMLHttpRequest();
                xhr.open("GET",locators.AtlasLocator(args.atlas));
                xhr.responseType="json";
                xhr.onload=descriptorReady;
                xhr.send();
            }
            
            var atlas;
            function descriptorReady(event){
                atlas=event.target.response;
                for(var label of atlas.labels)
                    if(label.rgb){
                        label.r=parseInt(label.rgb.substr(0,2),16);
                        label.g=parseInt(label.rgb.substr(2,2),16);
                        label.b=parseInt(label.rgb.substr(4,2),16);
                    }
                atlas.transformations.unshift({
                    name:"File coords",
                    matrix:[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]
                });
                for(var trf of atlas.transformations){
                    var opt=document.createElement("option");
                    opt.text=trf.name;
                    document.getElementById("traf").appendChild(opt);
                }
                filmstrip.start();
            }
            
            var markers=[];
            var poi=[];
            var allmarkers={};
            var allpoi={};
            var ouv={};
            var section_id;
            
            var vertices;
            var triangles;
            function triangulate(){
                vertices=[[0,0],[cfg.Width,0],[0,cfg.Height],[cfg.Width,cfg.Height]];
                triangles=[[0,1,2],[1,2,3]];
                // i<j j*(j-1)/2+i
                function ix(i,j){return j*(j-1)/2+i;}
//                var edges=new Array((markers.length+4)*(markers.length+5)/2).fill(0);
                var edges=[2,2,2,0,2,2];
                
                var smallorg=[[0,0],[overlaywidth-1,0],[0,overlayheight-1],[overlaywidth-1,overlayheight-1]];
                var small=[[0,0],[overlaywidth-1,0],[0,overlayheight-1],[overlaywidth-1,overlayheight-1]];
                
                for(var marker of markers){
                    var D=[marker.nx,marker.ny];
                    var found=false;
                    var remove=[];
                    for(var i=0;i<triangles.length;i++){
                        var triangle=triangles[i];
                        var A=vertices[triangle[0]];
                        var B=vertices[triangle[1]];
                        var C=vertices[triangle[2]];
                        if(!found && intri(A,B,C,D))
                            found=true;
                        if(incirc(A,B,C,D))
                            remove.unshift(i);
                    }
                    if(found){
                        for(var i of remove){
                            var triangle=triangles.splice(i,1)[0];
                            var A=triangle[0];
                            var B=triangle[1];
                            var C=triangle[2];
                            edges[ix(A,B)]--;
                            edges[ix(A,C)]--;
                            edges[ix(B,C)]--;
                        }
                        var es=[];
                        for(var j=1;j<vertices.length;j++)
                            for(var i=0;i<j;i++)
                                if(edges[ix(i,j)]===1){
                                    triangles.push([i,j,vertices.length]);
                                    es.push([i,j],[i,vertices.length],[j,vertices.length]);
                                }
//                        console.log(es);
//                        console.log(edges.toString());
                        for(var e of es)
                            edges[ix(e[0],e[1])]=2; //..
//                        console.log(edges.toString());
                        vertices.push(D);
                        smallorg.push([marker.x*overlaywidth/cfg.Width,marker.y*overlayheight/cfg.Height]);
                        small.push([marker.nx*overlaywidth/cfg.Width,marker.ny*overlayheight/cfg.Height]);
                    }
                }
                
                for(var triangle of triangles){
                    var A=small[triangle[0]];
                    var B=small[triangle[1]];
                    var C=small[triangle[2]];
                    triangle.push(
                        Math.min(A[0],B[0],C[0]), //3
                        Math.max(A[0],B[0],C[0]), //4
                        Math.min(A[1],B[1],C[1]), //5
                        Math.max(A[1],B[1],C[1]), //6
                        inv3x3([                  //7
                            [B[0]-A[0],B[1]-A[1],0],
                            [C[0]-A[0],C[1]-A[1],0],
                            [A[0],A[1],1]
                        ]));
                }
                
                var i=0,pi=0;
                var c=[[0,0,1]];
                odta=omgdata.data;
//                var color=show_outline.value!=="#ffffff" && show_outline.value;
                var color=document.getElementById("alpha").value==="100" && document.getElementById("outline").value;
                if(color){
                    color=[
                        parseInt(color.substring(1,3),16),
                        parseInt(color.substring(3,5),16),
                        parseInt(color.substring(5,7),16)
                    ];
                }
                for(var y=0;y<overlayheight;y++){
                    c[0][1]=y;
                    for(var x=0;x<overlaywidth;x++){
                        c[0][0]=x;
                        var found=false;
                        for(var triangle of triangles)
                            if(x>=triangle[3] && x<=triangle[4] && y>=triangle[5] && y<=triangle[6]){
                                var uv1=mult(c,triangle[7])[0];
                                if(uv1[0]>=0 && uv1[0]<1 && uv1[1]>=0 && uv1[1]<1 && uv1[0]+uv1[1]<=1){
                                    var A=smallorg[triangle[0]];
                                    var B=smallorg[triangle[1]];
                                    var C=smallorg[triangle[2]];
                                    var xx=Math.round(A[0]+(B[0]-A[0])*uv1[0]+(C[0]-A[0])*uv1[1]);
                                    var yy=Math.round(A[1]+(B[1]-A[1])*uv1[0]+(C[1]-A[1])*uv1[1]);
                                    var id=overlayorg[xx+yy*overlaywidth]||0; //!!?? hack, todo 7608 (9?)
                                    overlaydata[i++]=id;
                                    if(id!==0){
                                        var l=atlas.labels[id];
    //                                    try{
                                        odta[pi++]=l.r;
    //                                }catch(e){
    //                                    console.log(uv1,xx,yy,id);
    //                                }
                                        odta[pi++]=l.g;
                                        odta[pi++]=l.b;
                                        odta[pi++]=255;
                                    }else{
                                        odta[pi++]=odta[pi++]=odta[pi++]=odta[pi++]=0;
                                    }
                                    found=true;
                                    break;
                                }
                            }
                        if(!found){ 
                            overlaydata[i++]=0;
                            odta[pi++]=0;
                            odta[pi++]=0;
                            odta[pi++]=0;
                            odta[pi++]=0;
                        }
                        if(color){
                            if(x===0 || y===0 || (overlaydata[i-1]===overlaydata[i-2] && overlaydata[i-1]===overlaydata[i-1-overlaywidth]))
                                odta[pi-1]=odta[pi-2]=odta[pi-3]=odta[pi-4]=0;
                            else{
                                odta[pi-4]=color[0];
                                odta[pi-3]=color[1];
                                odta[pi-2]=color[2];
                                odta[pi-1]=255;
                            }
                        }
                    }
                }
                octx.putImageData(omgdata,0,0);
            }

            function dispatchOuv(newouv){
                if(section_id){
                    allmarkers[section_id]=markers;
                    allpoi[section_id]=poi;
                }
                ouv=newouv;
                section_id=ouv["id"];
//                if(allmarkers[section_id]){
//                    markers=allmarkers[section_id];
//                }else{
//                    markers=[];
//                }
                
//                var xhr=new XMLHttpRequest();
//    
//                xhr.open("GET",locators.RLELocator(nifti,ouv.ox,ouv.oy,ouv.oz,ouv.ux,ouv.uy,ouv.uz,ouv.vx,ouv.vy,ouv.vz));
//                
//                xhr.responseType="arraybuffer";
//                xhr.onload=overlayReady;
//                xhr.send();
                var data=dataslice(ouv);
                var w=overlay.width=overlaywidth=data.width;
                var h=overlay.height=overlayheight=data.height;
                octx=overlay.getContext("2d");
                omgdata=octx.createImageData(w,h);
                odta=omgdata.data;
                overlaydata=new Uint16Array(w*h);
                //overlayorg=new Uint16Array(w*h);
                var d=overlayorg=data.data;
                for(var i=0,is=0;i<d.length;i++){
                    var col=atlas.labels[overlaydata[i]=d[i]];
                    odta[is++]=col.r;
                    odta[is++]=col.g;
                    odta[is++]=col.b;
                    odta[is++]=255;
                }
                octx.putImageData(omgdata,0,0);
                
                var xhr=new XMLHttpRequest();
                xhr.open("GET",locators.DZILocator(section_id));
                xhr.onload=xmlReady;
                xhr.send();
            }
            
            var overlay=document.createElement("canvas");
            var overlaydata,overlayorg;
            var overlaywidth;
            var overlayheight;
            var octx,omgdata,odta;

            var pop=null;
            var popscape=false;
            var zoomer;
            var cfg;
            function xmlReady(event){
//!!                var doc=event.target.responseXML.documentElement;
                var doc=new DOMParser().parseFromString(event.target.responseText,"text/xml").documentElement;
                var size=doc.getElementsByTagName("Size").item(0);
                cfg={
                    TileSize:parseInt(doc.getAttribute("TileSize")),
                    Overlap:parseInt(doc.getAttribute("Overlap")),
                    Format:doc.getAttribute("Format"),
                    Width:parseInt(size.getAttribute("Width")),
                    Height:parseInt(size.getAttribute("Height")),
                    //FillStyle:"#00FF00",
                    MaxLevel:0
                };
                
//                ouv.w=cfg.Width;
//                ouv.h=cfg.Height;
                visualign();
                if(allmarkers[section_id]){
                    markers=allmarkers[section_id];
                }else{
                    markers=[];
                }
                if(ouv.w!==cfg.Width || ouv.h!==cfg.Height){
                    for(let marker of markers){
                        marker.x*=cfg.Width/ouv.w;
                        marker.y*=cfg.Height/ouv.h;
                        marker.nx*=cfg.Width/ouv.w;
                        marker.ny*=cfg.Height/ouv.h;
                    }
                    ouv.w=cfg.Width;
                    ouv.h=cfg.Height;
//                    alert("!");
                }
                if(allpoi[section_id]){
                    poi=allpoi[section_id];
                }else{
                    poi=[];
                }
                triangulate();
                
                var meta=document.getElementById("metadata");
                meta.innerHTML=/*ouv.name*/section_id+"<br>"+cfg.Width.toString()+" x "+cfg.Height.toString()+"<br>"
                        +atlas.name
                        +(args.prev?"":("<br><a href='http://cmbn-navigator.uio.no/navigator/feeder/original/?id="+section_id+"' target='_blank'>Download image</a>"));
                meta.style.left=window.innerWidth-meta.scrollWidth-5+"px";
                
                var w=cfg.Width;
                var h=cfg.Height;
                while(w>1 || h>1){
                    w=(w+1)>>1;
                    h=(h+1)>>1;
                    cfg.MaxLevel++;
                }

                cfg.Key=function(level,x,y){
                    return locators.TileLocator(section_id,this.MaxLevel-level,x,y,cfg.Format);
                };
                cfg.Load=function(key,x,y,next){
                    var img=document.createElement("img");
                    var canvas=document.createElement("canvas");
                    canvas.width=cfg.TileSize;
                    canvas.height=cfg.TileSize;
                    img.onload=function(){
                        canvas.getContext("2d").drawImage(img,x===0?0:-cfg.Overlap,y===0?0:-cfg.Overlap);
                        next(canvas);
                    };
                    img.onerror=function(){
                        console.log("Invalid tile? "+x+","+y+" "+key);
                        next(canvas);
                    };
                    img.src=key;
                };
                cfg.Overlay=function(ctx,cw,ch,x,y,w,h){
//                    var bright=parseInt(document.getElementById("bright").value);
//                    if(bright>1){
//                      var bdata=ctx.getImageData(0,0,cw,ch);
//                      var bdat=bdata.data;
//                      for(var i=0;i<cw*ch*4;i++)
//                        bdat[i]*=bright;
//                      ctx.putImageData(bdata,0,0);
//                    }
                    var ovltrgx=0;
                    var ovltrgy=0;
                    var ovltrgw=cw;
                    var ovltrgh=ch;
                    var ovlcutx=overlay.width*x/cfg.Width;
                    var ovlcuty=overlay.height*y/cfg.Height;
                    var ovlcutw=overlay.width*w/cfg.Width;
                    var ovlcuth=overlay.height*h/cfg.Height;
                    if(ovlcutx<0){
                        ovltrgx=-x*cw/w;
                        ovlcutx=0;
                    }
                    if(ovlcuty<0){
                        ovltrgy=-y*ch/h;
                        ovlcuty=0;
                    }
                    if(ovlcutw>overlay.width){
                        ovltrgw-=(w-cfg.Width)*cw/w;
                        ovlcutw=overlay.width;
                    }
                    if(ovlcuth>overlay.height){
                        ovltrgh-=(h-cfg.Height)*ch/h;
                        ovlcuth=overlay.height;
                    }
                    var alpha=parseInt(document.getElementById("alpha").value);
                    ctx.globalAlpha=alpha/100;
                    ctx.drawImage(overlay,ovlcutx,ovlcuty,ovlcutw,ovlcuth,ovltrgx,ovltrgy,ovltrgw,ovltrgh);
                    ctx.globalAlpha=1;

                    if(show_triangles.checked){
                        ctx.strokeStyle="#000000";
                        ctx.lineWidth=2.5;
                        ctx.beginPath();
                        triangles.forEach(function(triangle){
                            var v=vertices[triangle[2]];
                            ctx.moveTo(
                                    Math.round((v[0]-x)*cw/w)+0.5,
                                    Math.round((v[1]-y)*ch/h)+0.5
                            );
                            for(var i=0;i<3;i++){
                                var v=vertices[triangle[i]];
                                ctx.lineTo(
                                        Math.round((v[0]-x)*cw/w)+0.5,
                                        Math.round((v[1]-y)*ch/h)+0.5
                                );
                            }
                        });
                        ctx.stroke();
                    }
                    if(!args.view){
                        if(args.nl){
                            ctx.strokeStyle="#FFFF80";
                            try {ctx.strokeStyle=document.getElementById("nlcolor").value;} catch (ex) {}
                            ctx.lineWidth=2.5;
                            ctx.beginPath();
                            for(var i=0;i<markers.length;i++){
                                ctx.moveTo(Math.round((markers[i].x-x)*cw/w)+0.5,
                                           Math.round((markers[i].y-y)*ch/h)+0.5);
                                var sx=Math.round((markers[i].nx-x)*cw/w)+0.5;
                                var sy=Math.round((markers[i].ny-y)*ch/h)+0.5;
                                ctx.lineTo(sx,sy);
                                ctx.moveTo(sx,sy-10);
                                ctx.lineTo(sx,sy+10);
                                ctx.moveTo(sx-10,sy);
                                ctx.lineTo(sx+10,sy);
                            }
                            ctx.stroke();
                        }else{
                            ctx.strokeStyle="#FFFF80";
                            try {ctx.strokeStyle=document.getElementById("ancolor").value;} catch (ex) {}
                            ctx.lineWidth=2.5;
                            ctx.beginPath();
                            for(var i=0;i<poi.length;i++){
                                var sx=Math.round((poi[i].x-x)*cw/w)+0.5;
                                var sy=Math.round((poi[i].y-y)*ch/h)+0.5;
                                ctx.moveTo(sx,sy-10);
                                ctx.lineTo(sx,sy+10);
                                ctx.moveTo(sx-10,sy);
                                ctx.lineTo(sx+10,sy);
                            }
                            ctx.stroke();
                        }
                    }
                    if((pop!==null)&&(alpha!==0)){
                        ctx.fillStyle="rgb("+pop.r+","+pop.g+","+pop.b+")";
                        if(popscape)
                            ctx.fillRect(0,0,cw,60);
                        else
                            ctx.fillRect(0,ch-60,cw,60);
                        ctx.font="40px sans-serif";
                        ctx.fillStyle="#000000";
                        ctx.textAlign="center";
                        ctx.textBaseline="middle";
                        if(popscape)
                            ctx.fillText(pop.name,cw/2,30);
                        else
                            ctx.fillText(pop.name,cw/2,ch-30);
                    }
                };
                var cursor={
                  screenx:0,screeny:0,imagex:0,imagey:0
                };
                var prevalpha;
                cfg.MouseMove=function(event,cw,ch,x,y,w,h){
                    cursor.screenx=event.offsetX;
                    cursor.screeny=event.offsetY;
                    var mx=cursor.imagex=Math.round(x+event.offsetX*w/cw);
                    var my=cursor.imagey=Math.round(y+event.offsetY*h/ch);
                    if(markerpick!==undefined){
                        if(args.nl){
                            markers[markerpick].nx=mx;
                            markers[markerpick].ny=my;
                            triangulate();
                        }else{
                            poi[markerpick].x=mx;
                            poi[markerpick].y=my;
                        }
                        drawImage();
                        return;
                    }
                    var jump=false;
                    if(popscape && event.offsetY<ch/3){
                        popscape=false;
                        jump=true;
                    }
                    if(!popscape && event.offsetY>ch*2/3){
                        popscape=true;
                        jump=true;
                    }
                    var div=document.getElementById("coords");
                    var nx=mx/cfg.Width;
                    var ny=my/cfg.Height;
                    //!! todo: nonlin
                    var fx=ouv.ox+ouv.ux*nx+ouv.vx*ny;
                    var fy=ouv.oy+ouv.uy*nx+ouv.vy*ny;
                    var fz=ouv.oz+ouv.uz*nx+ouv.vz*ny;
                    var trf=atlas.transformations[document.getElementById("traf").selectedIndex];
                    var xyz1=mult([[fx,fy,fz,1]],trf.matrix)[0];
                    div.innerText="(x="+xyz1[0].toPrecision(5)+" y="+xyz1[1].toPrecision(5)+" z="+xyz1[2].toPrecision(5)+")";
                    nx=Math.round(nx*overlaywidth);
                    ny=Math.round(ny*overlayheight);
                    var oldpop=pop;
                    pop=null;
                    if((nx>=0)&&(nx<overlaywidth)&&(ny>=0)&&(ny<overlayheight)){
                        pop=overlaydata[nx+ny*overlaywidth];
                        pop=pop===0?null:atlas.labels[pop];
                    }
                    if(oldpop!==pop || jump)drawImage();
                };
                var markerpick;
                cfg.MouseDown=function(event,cw,ch,x,y,w,h){
                    if(args.view)return false;
                    markerpick=undefined;
                    if(args.nl){
                        for(var i=0;i<markers.length;i++){
                            var sx=Math.round((markers[i].nx-x)*cw/w)+0.5;
                            var sy=Math.round((markers[i].ny-y)*ch/h)+0.5;
                            if(event.offsetX>sx-10 && event.offsetX<sx+10 && event.offsetY>sy-10 && event.offsetY<sy+10)
                                markerpick=i;
                        }
                    }else{
                        for(var i=0;i<poi.length;i++){
                            var sx=Math.round((poi[i].x-x)*cw/w)+0.5;
                            var sy=Math.round((poi[i].y-y)*ch/h)+0.5;
                            if(event.offsetX>sx-10 && event.offsetX<sx+10 && event.offsetY>sy-10 && event.offsetY<sy+10)
                                markerpick=i;
                        }
                    }
                    return markerpick!==undefined;
                };
                cfg.MouseUp=function(event,cw,ch,x,y,w,h){
                    markerpick=undefined;
                };
                cfg.KeyDown=function(event,cw,ch,x,y,w,h){
                    var alpha=document.getElementById("alpha");
                    switch(event.key){
                        case "ArrowLeft":
                            filmstrip.prev();
                            break;
                        case "ArrowRight":
                            filmstrip.next();
                            break;
                        case "ArrowUp":
                            if(prevalpha){
                                alpha.value=prevalpha;
                                drawImage();
                            }
                            break;
                        case "ArrowDown":
                            if(alpha.value!=="0"){
                                prevalpha=alpha.value;
                                alpha.value=0;
                                drawImage();
                            }
                            break;
                        case "Delete":
                            if(!args.view){
                                if(args.nl){
                                    var idx=undefined;
                                    for(var i=0;i<markers.length;i++){
                                        var sx=Math.round((markers[i].x-x)*cw/w)+0.5;
                                        var sy=Math.round((markers[i].y-y)*ch/h)+0.5;
                                        if(cursor.screenx>sx-8 && cursor.screenx<sx+8 && cursor.screeny>sy-8 && cursor.screeny<sy+8)
                                            idx=i;
                                        var sx=Math.round((markers[i].nx-x)*cw/w)+0.5;
                                        var sy=Math.round((markers[i].ny-y)*ch/h)+0.5;
                                        if(cursor.screenx>sx-8 && cursor.screenx<sx+8 && cursor.screeny>sy-8 && cursor.screeny<sy+8)
                                            idx=i;
                                    }
                                    if(idx!==undefined){
                                        markers.splice(idx,1);
                                        triangulate();
                                        drawImage();
                                    }
                                }else{
                                    var idx=undefined;
                                    for(var i=0;i<poi.length;i++){
                                        var sx=Math.round((poi[i].x-x)*cw/w)+0.5;
                                        var sy=Math.round((poi[i].y-y)*ch/h)+0.5;
                                        if(cursor.screenx>sx-8 && cursor.screenx<sx+8 && cursor.screeny>sy-8 && cursor.screeny<sy+8)
                                            idx=i;
                                    }
                                    if(idx!==undefined){
                                        poi.splice(idx,1);
                                        drawImage();
                                    }
                                }
                            }
                            break;
                        default:
                            if(!args.view && cursor.imagex>=0 && cursor.imagey>=0 && cursor.imagex<=cfg.Width && cursor.imagey<=cfg.Height){
                                if(args.nl){
                                    var D=[cursor.imagex,cursor.imagey];
                                    for(var triangle of triangles){
                                        var ai=triangle[0];
                                        var bi=triangle[1];
                                        var ci=triangle[2];
                                        var A=vertices[ai];
                                        var B=vertices[bi];
                                        var C=vertices[ci];
                                        var uv1=intri(A,B,C,D);
                                        if(uv1){
    //                                        console.log(uv1);
                                            if(ai>=4)
                                                A=markers[ai-4];
                                            else
                                                A={x:vertices[ai][0],y:vertices[ai][1]};
                                            if(bi>=4)
                                                B=markers[bi-4];
                                            else
                                                B={x:vertices[bi][0],y:vertices[bi][1]};
                                            if(ci>=4)
                                                C=markers[triangle[2]-4];
                                            else
                                                C={x:vertices[ci][0],y:vertices[ci][1]};
                                            markers.push({
                                                x:A.x+(B.x-A.x)*uv1[0]+(C.x-A.x)*uv1[1],
                                                y:A.y+(B.y-A.y)*uv1[0]+(C.y-A.y)*uv1[1],
                                                nx:cursor.imagex,
                                                ny:cursor.imagey
                                            });
    //                                        console.log(markers[markers.length-1]);
                                            D=false;
                                            break;
                                        }
                                    }
                                    if(D){
    //                                    console.log("!");
                                        markers.push({x:cursor.imagex,y:cursor.imagey,nx:cursor.imagex,ny:cursor.imagey});
                                    }
                                    triangulate();
                                    drawImage();
                                }else{
                                    poi.push({x:cursor.imagex,y:cursor.imagey});
                                    drawImage();
                                }
                            }
                    }
                };
                if(zoomer)zoomer.detach();
                zoomer=new Zoomer(document.getElementById("zoomcanvas"),cfg);
                zoomer.fullcanvas();
            }
            function drawImage(){if(zoomer)zoomer.redraw();}
            function excel(){
                // todo: nonlin/canonicalize
                var wnd=window.open("about:blank","Excel export #"+Date.now());
                var d=wnd.document;
                d.write("<html><head><title>Excel export</title><style>textarea{width:100%;height:80%}</style><script>");
                d.write("function swapdots(){var e=document.getElementById('ta');e.innerHTML=e.innerHTML.replace(/\\./g,',');}");
                d.write("function swapcommas(){var e=document.getElementById('ta');e.innerHTML=e.innerHTML.replace(/,/g,'.');}");
                d.write("<\/script></head><body><textarea id='ta'>");
                var s="ID\t"+ouv.id+"\t\t\tHIDE\tHIDE\n";
                s+="Resolution\t"+cfg.Width+"\t"+cfg.Height+"\n";
                s+="\n";
                s+="Anchor\tx\ty\tz\n";
                s+="o\t"+ouv.ox+"\t"+ouv.oy+"\t"+ouv.oz+"\n";
                s+="u\t"+ouv.ux+"\t"+ouv.uy+"\t"+ouv.uz+"\n";
                s+="v\t"+ouv.vx+"\t"+ouv.vy+"\t"+ouv.vz+"\n";
                s+="\n";
                if(atlas.transformations.length===1){
                    s+="Marker#\tx\ty\t\tnx\tny\tfx\tfy\tfz\n";
                    for(var i=0;i<poi.length;i++){
                        var line=i+10;
                        s+=(i+1)+"\t"+poi[i].x+"\t"+poi[i].y+"\t\t"
                            +"=B"+line+"/$B$2\t=C"+line+"/$C$2\t"
                            +"=B$5+B$6*$E"+line+"+B$7*$F"+line+"\t=C$5+C$6*$E"+line+"+C$7*$F"+line+"\t=D$5+D$6*$E"+line+"+D$7*$F"+line+"\n";
                    }
                }else{
                    var bak=atlas.transformations.shift();

                    for(var i=0;i<4;i++){
                        s+="HIDE\t\t\t\t\t\t\t\t";
                        for(var t of atlas.transformations)
                            s+="\t"+t.matrix[i][0]+"\t"+t.matrix[i][1]+"\t"+t.matrix[i][2];
                        s+="\n";
                    }

                    s+="\t\t\t\t\t\t";
                    for(var t of atlas.transformations)
                        s+="\t\t\t"+t.name;
                    s+="\n";
                    
                    s+="Marker#\tx\ty\t\tnx\tny\tfx\tfy\tfz";
                    for(var t of atlas.transformations)
                        s+="\tx\ty\tz";
                    s+="\n";
                    
                    atlas.transformations.unshift(bak);
                    
                    function idxr(i){
                        var h=Math.floor(i/26);
                        var l=i-h*26;
                        var A="A".charCodeAt();
                        if(h===0)return String.fromCharCode(A+l);
                        return String.fromCharCode(A+h-1)+String.fromCharCode(A+l);
                    }

                    for(var i=0;i<poi.length;i++){
                        var line=i+15;
                        s+=(i+1)+"\t"+poi[i].x+"\t"+poi[i].y+"\t\t"
                            +"=B"+line+"/$B$2\t=C"+line+"/$C$2\t"
                            +"=B$5+B$6*$E"+line+"+B$7*$F"+line+"\t=C$5+C$6*$E"+line+"+C$7*$F"+line+"\t=D$5+D$6*$E"+line+"+D$7*$F"+line;
                        for(var t=1;t<atlas.transformations.length;t++)
                            s+="\t=$G"+line+"*"+idxr(6+t*3)+"$9+$H"+line+"*"+idxr(6+t*3)+"$10+$I"+line+"*"+idxr(6+t*3)+"$11+"+idxr(6+t*3)+"$12\t=$G"+line+"*"+idxr(6+t*3+1)+"$9+$H"+line+"*"+idxr(6+t*3+1)+"$10+$I"+line+"*"+idxr(6+t*3+1)+"$11+"+idxr(6+t*3+1)+"$12\t=$G"+line+"*"+idxr(6+t*3+2)+"$9+$H"+line+"*"+idxr(6+t*3+2)+"$10+$I"+line+"*"+idxr(6+t*3+2)+"$11+"+idxr(6+t*3+2)+"$12";
                        s+="\n";
                    }
                }
                d.write(s);
                d.write("</textarea>Code above can be copied into an Excel sheet<br>Swap decimal dots to commas: <button onclick='swapdots()'>. -> ,</button> and revert: <button onclick='swapcommas()'>, -> .</button></body></html>");
                d.close();
            }
            function meshview(){
                allpoi[section_id]=poi;
//                let wnd=window.open("https://meshview.apps.hbp.eu?atlas=AMBA_CCFv3_root","MeshView #"+Date.now());
                let wnd=window.open("https://meshview.apps.hbp.eu?atlas="+(args.atlas.startsWith("WHS")?"WHS_SD_Rat_v2_39um":"ABA_Mouse_CCFv3_2015_25um"),"MeshView #"+Date.now());
                let color=document.getElementById("ancolor").value.substring(1);
                let r=parseInt(color.substring(0,2),16);
                let g=parseInt(color.substring(2,4),16);
                let b=parseInt(color.substring(4,6),16);
                let message=[];
                for(let section of filmstrip.getmeta()){
                    let markers=allpoi[section.id] || [];
                    if(markers.length){
                        let triplets=[];
                        for(let marker of markers){
                            let nx=marker.x/section.w;
                            let ny=marker.y/section.h;
                            let x=section.ox+section.ux*nx+section.vx*ny;
                            let y=section.oy+section.uy*nx+section.vy*ny;
                            let z=section.oz+section.uz*nx+section.vz*ny;
                            triplets.push(x,y,z);
                        }
                        message.push({name:section.id,r,g,b,triplets});
                    }
                }
                onmessage=()=>{
                    wnd.postMessage(message,"*");
                };
                return;
                //var wnd=window.open("about:blank","MeshView #"+Date.now());
                var d=wnd.document;
                d.write("<html><head><title>MeshView export</title><style>textarea{width:100%;height:80%}</style></head><body>");
                d.write("Please copy the coordinates below into <a href='http://www.nesys.uio.no/MeshGen/MeshView.html?bitlas="
                    +JSON.parse('{"100000":"ABAMouseHier","200000":"WHSRatV2","300000":"ABAv3-Hier"}')[args.atlas]
                    +".bitlas' target='_blank'>MeshView</a>. Viewer needs Adobe Flash.");
                if(args.atlas==="100000")d.write("<br>(Hint: \"Basic cell groups and regions\" is the gray wrapper structure to be switched off)");
                if(args.atlas==="300000")d.write("<br>(Hint: \"root\" is the gray wrapper structure to be switched off)");
                d.write("<textarea id='ta'>");
                d.write("RGB 0 0 1\n");
                d.write("SCALE 5\n");
                filmstrip.getmeta().forEach(function(section){
                    var markers=allpoi[section.id] || [];
                    if(markers.length){
                        d.write("\n# "+section.name+"\n");
                        markers.forEach(function(marker){
                            var nx=marker.x/section.w;
                            var ny=marker.y/section.h;
                            var x=section.ox+section.ux*nx+section.vx*ny;
                            var y=section.oy+section.uy*nx+section.vy*ny;
                            var z=section.oz+section.uz*nx+section.vz*ny;
                            if(args.atlas==="100000"){
                                y-=528;
                                z-=320;
                            }
                            d.write(x.toFixed(0)+" "+y.toFixed(0)+" "+z.toFixed(0)+"\n");
                        });
                    }
                });
                d.write("</textarea></body></html>");
                d.close();
            }
            
            function metaReady(metahack,callback){
                loadMarkers(metahack);
                callback();
//                var xhr=new XMLHttpRequest();
//                xhr.open("GET",args.series+".json");
////                xhr.responseType="json";
//                xhr.onload=xhr.onerror=function(){
//                    if(xhr.status===200)
//                        loadMarkers(xhr.responseText);
//                    callback();
//                };
//                xhr.send();
            }
            
            function loadMarkers(data){
                var meta=filmstrip.getmeta();
                allmarkers={};
                var uglymeta={};
//                data=JSON.parse(data);
                if(Array.isArray(data)){ // own format
                    meta.forEach(function(m){uglymeta[m.id]=m;delete m.vam;});
                    data.forEach(function(section){
                        var id=section.id;
                        var meta=uglymeta[id];
                        meta.w=section.w;
                        meta.h=section.h;
                        allmarkers[id]=section.markers;
                    });
                } else { // VisuAlign format
                    var r=/_s(\d+)/;
                    meta.forEach(function(m){uglymeta[m.s/*allnumbered?m.s:m.name*/]=m;});
                    data.slices.forEach(function(section){
                        var name=section.filename;
                        if(name){
//                        name=name.substring(0,name.lastIndexOf("."));
                        //var meta=uglymeta[name];
                        var meta=uglymeta[section.hasOwnProperty("nr")?section.nr:/*allnumbered?*/parseInt(r.exec(name)[1])/*:name.substring(0,name.lastIndexOf("."))*/];
if(!meta){
  var frag=name.substring(0,name.lastIndexOf("."));
  filmstrip.getmeta().forEach(function(m){
    if(m.name.indexOf(frag)>=0)
      meta=m;
  });
}
                        //var meta=uglymeta[allnumbered?parseInt(section.nr):name.substring(0,name.lastIndexOf("."))];
                        if(section.markers && meta){
                            meta.vaw=section.width;
                            meta.vah=section.height;
                            meta.vam=section.markers;
                            var ouv=section.anchoring;
                            meta.ox=ouv[0];meta.oy=ouv[1];meta.oz=ouv[2];
                            meta.ux=ouv[3];meta.uy=ouv[4];meta.uz=ouv[5];
                            meta.vx=ouv[6];meta.vy=ouv[7];meta.vz=ouv[8];
                        }
//                            allmarkers[meta.id]=section.markers.map(function(marker){
//                                return {x:marker[0],y:marker[1],nx:marker[2],ny:marker[3]};
//                            });
                        }
                    });
                    visualign();
                }
            }
            
            function visualign(){
                var hide=false;
                filmstrip.getmeta().forEach(function(meta){
                    if(meta.vam){
                        if(!meta.w)
                            hide=true;
                        else{
                            allmarkers[meta.id]=meta.vam.map(function(marker){
                                return {
                                    x:marker[0],//*meta.w/meta.vaw,
                                    y:marker[1],//*meta.h/meta.vah,
                                    nx:marker[2],//*meta.w/meta.vaw,
                                    ny:marker[3]/**meta.h/meta.vah*/};
                            });
                            delete meta.vam;
                        }
                    }
                });
                document.getElementById("btn_save").disabled=hide;
            }
            
            function load(){
                var data=prompt("LocaliZoom nonlinear JSON","");
                if(data===null || data==="")return;
                loadMarkers(data);
                markers=allmarkers[section_id] || [];
                triangulate();
                drawImage();
            }
            function save(){
                if(section_id)allmarkers[section_id]=markers;
                var meta=filmstrip.getmeta();
                var data=[];
                meta.forEach(function(section){
                    var smarkers=allmarkers[section.id];
                    if(smarkers && smarkers.length){
                        data.push({id:section.id,w:section.w,h:section.h,markers:smarkers});
                    }
                });
                var win=window.open("about:blank","LZSave #"+Date.now());
                var d=win.document.open();
                d.write(JSON.stringify(data));
                d.close();
            }
            
            function toggleHelp(){
                var helpstyle=document.getElementById("help").style;
                helpstyle.display=helpstyle.display==="block"?"none":"block";
            }
//            function toggleTools(){
//                var toolstyle=document.getElementById("toolsinner").style;
//                toolstyle.display=toolstyle.display==="inline-block"?"none":"inline-block";
//            }
            function toggleAN(){
                var toolstyle=document.getElementById("antools").style;
                toolstyle.display=toolstyle.display==="inline-block"?"none":"inline-block";
            }
            function toggleNL(){
                var toolstyle=document.getElementById("nltools").style;
                toolstyle.display=toolstyle.display==="inline-block"?"none":"inline-block";
            }
            function handleOvly(event){
                if(event.target.type==="color")
                    document.getElementById("alpha").value=100;
                triangulate();
                drawImage();
            }
        </script>
    </head>
    <body onload="startup()">
        <div id="status">
            <select id="traf"></select>
<!--            <input type="range" id="bright" min="1" max="20" step="0.2" value="1" onchange="drawImage()">
            <div id="brightdesc">Brighten image:</div>-->
            <input type="color" value="#0000FF" id="outline" onchange="handleOvly(event)">
            <div id="outlinedesc">Outline:</div>
            <input type="range" id="alpha" min="0" max="100" step="10" value="100" onchange="handleOvly(event)">
            <div id="alphadesc">Atlas opacity:</div>
            <div id="coords"></div>
        </div>
        <div id="helpbutton"><button onclick="toggleHelp()">?</button></div>
        <div id="tools">
            <button id="toggleAN" onclick="toggleAN()">Annotation tools</button>
            <button id="toggleNL" onclick="toggleNL()">Settings</button>
            <div id="antools">
                Marker color: <input type="color" id="ancolor" value="#000000" oninput="drawImage()" style="height: 18px">
                <!--<button onclick="load()">Load</button><button onclick="save()" id="btn_save">Save</button>-->
                Export to <button onclick="excel()">Excel</button> (this slice) or <button onclick="meshview()">MeshView</button> (all slices).
            </div>
            <div id="nltools">
                Marker color: <input type="color" id="nlcolor" value="#000000" oninput="drawImage()" style="height: 18px">
                <button onclick="load()">Load</button><button onclick="save()" id="btn_save">Save</button>
                <input type="checkbox" id="show_triangles" onchange="drawImage()">Show triangles
            </div>
<!--            <div id="toolsinner">
                Marker color: <input type="color" id="crosscolor" value="#000000" onchange="drawImage()" style="height: 18px">
                <button onclick="load()">Load</button><button onclick="save()" id="btn_save">Save</button>
                Export to <button onclick="excel()">Excel</button> (this slice) or <button onclick="meshview()">MeshView</button> (all slices).
                <input type="checkbox" id="show_triangles" onchange="drawImage()">Show triangles
            </div>-->
        </div>
        <canvas id="zoomcanvas" tabindex="1" onmouseover="event.target.focus()"></canvas>
        <canvas id="scroller" onclick="filmstrip.mclick(event)"></canvas>
        <div id="metadata"></div>
        <div id="help">
            Controls:<br>
            <ul>
                <li>Pan and zoom with mouse drag and mouse scroll wheel</li>
                <li>Step backwards and forwards in series with left and right arrow keys<sup><sub>*</sub></sup></li>
                <li>Quick set segmentation transparency to minimum and back using down and up arrow keys<sup><sub>*</sub></sup></li>
<!--                <li>Press Space<sup><sub>*</sub></sup> to annotate points of interest. Atlas coordinates for points of interest can be exported to Excel or MeshView atlas viewer (requires Adobe Flash)</li>
                <li>Press Delete<sup><sub>*</sub></sup> to remove an annotation marker under the mouse cursor</li>
                <li>Drag an annotation marker to refine its position</li>-->
            </ul>
            <a href="https://localizoom.readthedocs.io/" target="_blank">Documentation</a><br>
            <br>
            *: Click on main view to activate keyboard controls.
        </div>
    </body>
</html>
